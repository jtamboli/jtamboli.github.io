<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Eclipse Countdown</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
    </style>
    <script src="https://unpkg.com/tubular_astronomy/dist/tubular_astronomy.min.js"></script>
</head>
<body>
    <h1>Countdown to Solar Eclipse Totality</h1>
    <h2>April 8, 2024</h2>
    <form>
        <label for="latitude">Latitude:</label>
        <input type="text" id="latitude" name="latitude" required>
        <label for="longitude">Longitude:</label>
        <input type="text" id="longitude" name="longitude" required>
        <button type="button" onclick="calculateCountdown()">Calculate</button>
        <button type="button" onclick="useCurrentLocation()">Use Current Location</button>
    </form>
    <div id="countdown"></div>

    <script>
        async function calculateCountdown() {
            const latitude = parseFloat(document.getElementById("latitude").value);
            const longitude = parseFloat(document.getElementById("longitude").value);

            // Create a location object using the user's input
            const location = new tubular_astronomy.Location(latitude, longitude);

            // Set the eclipse date
            const eclipseDate = new Date("2024-04-08");

            // Find the solar eclipse event for the given location and date
            const eventFinder = new tubular_astronomy.EventFinder(location);
            const eclipseEvent = await eventFinder.findEventAsync(
                tubular_astronomy.SUN,
                tubular_astronomy.SOLAR_ECLIPSE_LOCAL,
                eclipseDate,
                eclipseDate
            );

            if (eclipseEvent && eclipseEvent.type === tubular_astronomy.SOLAR_ECLIPSE_LOCAL) {
                const eclipseStartTime = eclipseEvent.time;
                const eclipseEndTime = new Date(eclipseEvent.time.getTime() + eclipseEvent.duration * 1000);
                displayCountdown(eclipseStartTime, eclipseEndTime);
            } else {
                document.getElementById("countdown").innerHTML = "No solar eclipse found for the given location and date.";
            }
        }

        function useCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        document.getElementById("latitude").value = latitude;
                        document.getElementById("longitude").value = longitude;
                        calculateCountdown();
                    },
                    function(error) {
                        console.error("Error getting current location:", error);
                        alert("Unable to retrieve your location. Please enter the coordinates manually.");
                    }
                );
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function displayCountdown(eclipseStartTime, eclipseEndTime) {
            let totalityStarted = false;
            let totalityEndTime = null;

            // Update the countdown every second
            const countdownTimer = setInterval(function() {
                // Get the current date and time
                const now = new Date().getTime();

                if (!totalityStarted && now >= eclipseStartTime.getTime()) {
                    totalityStarted = true;
                    totalityEndTime = new Date(eclipseStartTime.getTime() + eclipseEvent.duration * 1000);
                    document.getElementById("countdown").innerHTML = "Totality has started!";
                }

                if (totalityStarted) {
                    const elapsedTime = now - eclipseStartTime.getTime();
                    const timeRemaining = totalityEndTime - now;

                    const elapsedDays = Math.floor(elapsedTime / (1000 * 60 * 60 * 24));
                    const elapsedHours = Math.floor((elapsedTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const elapsedMinutes = Math.floor((elapsedTime % (1000 * 60 * 60)) / (1000 * 60));
                    const elapsedSeconds = Math.floor((elapsedTime % (1000 * 60)) / 1000);

                    const remainingDays = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
                    const remainingHours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const remainingMinutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
                    const remainingSeconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);

                    document.getElementById("countdown").innerHTML = `Elapsed: ${elapsedDays}d ${elapsedHours}h ${elapsedMinutes}m ${elapsedSeconds}s<br>Remaining: ${remainingDays}d ${remainingHours}h ${remainingMinutes}m ${remainingSeconds}s`;

                    // If the countdown is finished, display a message
                    if (timeRemaining < 0) {
                        clearInterval(countdownTimer);
                        document.getElementById("countdown").innerHTML = "Totality has ended.";
                    }
                } else {
                    const timeRemaining = eclipseStartTime - now;

                    const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);

                    document.getElementById("countdown").innerHTML = `Countdown to totality: ${days}d ${hours}h ${minutes}m ${seconds}s`;
                }
            }, 1000);
        }
    </script>
</body>
</html>
